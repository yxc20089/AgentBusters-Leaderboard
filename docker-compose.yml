services:
  # MCP Server 1: SEC EDGAR
  sec-edgar-mcp:
    build:
      context: .
      dockerfile: Dockerfile.mcp-edgar
    container_name: fab-plus-edgar
    environment:
      - EDGAR_CACHE_DIR=/data/edgar_cache
      - TOKEN_TRACKING_ENABLED=true
      - NOISE_INJECTION_RATIO=0.3
      - TEMPORAL_LOCK_ENABLED=true
      - FASTMCP_TRANSPORT=http
    volumes:
      - edgar-cache:/data/edgar_cache
    ports:
      - "8101:8000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.create_connection(('localhost',8000),2); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MCP Server 2: Yahoo Finance
  yahoo-finance-mcp:
    build:
      context: .
      dockerfile: Dockerfile.mcp-yahoo
    container_name: fab-plus-yfinance
    environment:
      - YFINANCE_CACHE_DIR=/data/yf_cache
      - TIME_MACHINE_ENABLED=true
      - LOOKAHEAD_DETECTION=true
      - FASTMCP_TRANSPORT=http
    volumes:
      - yfinance-cache:/data/yf_cache
    ports:
      - "8102:8000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.create_connection(('localhost',8000),2); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MCP Server 3: Sandbox
  mcp-sandbox:
    build:
      context: .
      dockerfile: Dockerfile.mcp-sandbox
    container_name: fab-plus-sandbox
    environment:
      - EXECUTION_TIMEOUT=30
      - PRELOAD_LIBS=numpy,pandas,scipy,yfinance
      - FASTMCP_TRANSPORT=http
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    ports:
      - "8103:8000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.create_connection(('localhost',8000),2); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MCP Server 4: Options Chain (Black-Scholes pricing)
  options-chain-mcp:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fab-plus-options-chain
    command: ["fastmcp", "run", "src/mcp_servers/options_chain.py:create_options_chain_server", "--transport", "http", "--host", "0.0.0.0", "--port", "8000"]
    environment:
      - SIMULATION_DATE=${SIMULATION_DATE:-}
    ports:
      - "8104:8000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.create_connection(('localhost',8000),2); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MCP Server 5: Trading Simulator (Paper trading engine)
  trading-sim-mcp:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fab-plus-trading-sim
    command: ["fastmcp", "run", "src/mcp_servers/trading_sim.py:create_trading_sim_server", "--transport", "http", "--host", "0.0.0.0", "--port", "8000"]
    environment:
      - STARTING_CAPITAL=100000
      - COMMISSION_PER_CONTRACT=0.65
      - SIMULATION_DATE=${SIMULATION_DATE:-}
    volumes:
      - trading-data:/app/data
    ports:
      - "8105:8000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.create_connection(('localhost',8000),2); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MCP Server 6: Risk Metrics (Greeks, VaR, stress testing)
  risk-metrics-mcp:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fab-plus-risk-metrics
    command: ["fastmcp", "run", "src/mcp_servers/risk_metrics.py:create_risk_metrics_server", "--transport", "http", "--host", "0.0.0.0", "--port", "8000"]
    ports:
      - "8106:8000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.create_connection(('localhost',8000),2); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3

  # CIO-Agent Orchestrator (Green Agent / Evaluator)
  cio-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fab-plus-orchestrator
    environment:
      - MCP_EDGAR_URL=http://sec-edgar-mcp:8000/mcp
      - MCP_YFINANCE_URL=http://yahoo-finance-mcp:8000/mcp
      - MCP_SANDBOX_URL=http://mcp-sandbox:8000/mcp
      - MCP_OPTIONS_URL=http://options-chain-mcp:8000/mcp
      - MCP_TRADING_URL=http://trading-sim-mcp:8000/mcp
      - MCP_RISK_URL=http://risk-metrics-mcp:8000/mcp
      - A2A_PROTOCOL_VERSION=1.0
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    depends_on:
      sec-edgar-mcp:
        condition: service_healthy
      yahoo-finance-mcp:
        condition: service_healthy
      mcp-sandbox:
        condition: service_healthy
      options-chain-mcp:
        condition: service_healthy
      trading-sim-mcp:
        condition: service_healthy
      risk-metrics-mcp:
        condition: service_healthy
    ports:
      - "9109:9109"
    volumes:
      - evaluation-results:/data/results
      - ./finance-agent/data:/app/data:ro
      - ./scripts:/app/scripts:ro
    restart: unless-stopped

  # Purple Agent (Finance Analysis Agent under test)
  purple-agent:
    build:
      context: .
      dockerfile: Dockerfile.purple
    container_name: fab-plus-purple-agent
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - LLM_MODEL=${LLM_MODEL:-gpt-4o}
      - SIMULATION_DATE=${SIMULATION_DATE:-}
      - MCP_EDGAR_URL=http://sec-edgar-mcp:8000/mcp
      - MCP_YFINANCE_URL=http://yahoo-finance-mcp:8000/mcp
      - MCP_SANDBOX_URL=http://mcp-sandbox:8000/mcp
      - MCP_OPTIONS_URL=http://options-chain-mcp:8000/mcp
      - MCP_TRADING_URL=http://trading-sim-mcp:8000/mcp
      - MCP_RISK_URL=http://risk-metrics-mcp:8000/mcp
    ports:
      - "9110:8001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # PostgreSQL for evaluation storage (optional)
  postgres:
    image: postgres:15
    container_name: fab-plus-db
    environment:
      - POSTGRES_DB=fab_plus
      - POSTGRES_USER=fab_admin
      - POSTGRES_PASSWORD=${DB_PASSWORD:-secure_password}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped
    profiles:
      - with-db

volumes:
  edgar-cache:
  yfinance-cache:
  evaluation-results:
  postgres-data:
  trading-data:

networks:
  default:
    name: fab-plus-network
