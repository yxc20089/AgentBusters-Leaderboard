version: '3.8'

services:
  # MCP Server 1: SEC EDGAR
  sec-edgar-mcp:
    build:
      context: .
      dockerfile: Dockerfile.mcp-edgar
    container_name: fab-plus-edgar
    environment:
      - EDGAR_CACHE_DIR=/data/edgar_cache
      - TOKEN_TRACKING_ENABLED=true
      - NOISE_INJECTION_RATIO=0.3
      - TEMPORAL_LOCK_ENABLED=true
    volumes:
      - edgar-cache:/data/edgar_cache
    ports:
      - "8101:8000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MCP Server 2: Yahoo Finance
  yahoo-finance-mcp:
    build:
      context: .
      dockerfile: Dockerfile.mcp-yahoo
    container_name: fab-plus-yfinance
    environment:
      - YFINANCE_CACHE_DIR=/data/yf_cache
      - TIME_MACHINE_ENABLED=true
      - LOOKAHEAD_DETECTION=true
    volumes:
      - yfinance-cache:/data/yf_cache
    ports:
      - "8102:8000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MCP Server 3: Sandbox
  mcp-sandbox:
    build:
      context: .
      dockerfile: Dockerfile.mcp-sandbox
    container_name: fab-plus-sandbox
    environment:
      - EXECUTION_TIMEOUT=30
      - PRELOAD_LIBS=numpy,pandas,scipy,yfinance
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    ports:
      - "8103:8000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # CIO-Agent Orchestrator (Green Agent / Evaluator)
  cio-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fab-plus-orchestrator
    environment:
      - MCP_EDGAR_URL=http://sec-edgar-mcp:8000
      - MCP_YFINANCE_URL=http://yahoo-finance-mcp:8000
      - MCP_SANDBOX_URL=http://mcp-sandbox:8000
      - A2A_PROTOCOL_VERSION=1.0
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    depends_on:
      sec-edgar-mcp:
        condition: service_healthy
      yahoo-finance-mcp:
        condition: service_healthy
      mcp-sandbox:
        condition: service_healthy
    ports:
      - "8080:8080"
    volumes:
      - evaluation-results:/data/results
    restart: unless-stopped

  # Purple Agent (Finance Analysis Agent under test)
  purple-agent:
    build:
      context: .
      dockerfile: Dockerfile.purple
    container_name: fab-plus-purple-agent
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - LLM_MODEL=${LLM_MODEL:-gpt-4o}
      - SIMULATION_DATE=${SIMULATION_DATE:-}
      - MCP_EDGAR_URL=http://sec-edgar-mcp:8000
      - MCP_YFINANCE_URL=http://yahoo-finance-mcp:8000
      - MCP_SANDBOX_URL=http://mcp-sandbox:8000
    ports:
      - "8001:8001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # PostgreSQL for evaluation storage (optional)
  postgres:
    image: postgres:15
    container_name: fab-plus-db
    environment:
      - POSTGRES_DB=fab_plus
      - POSTGRES_USER=fab_admin
      - POSTGRES_PASSWORD=${DB_PASSWORD:-secure_password}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped
    profiles:
      - with-db

volumes:
  edgar-cache:
  yfinance-cache:
  evaluation-results:
  postgres-data:

networks:
  default:
    name: fab-plus-network
